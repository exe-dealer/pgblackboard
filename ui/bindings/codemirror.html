<link rel="import" href="../knockout.html" />
<link rel="import" href="../fontello.html" />

<link rel="stylesheet" href="../../node_modules/codemirror/lib/codemirror.css" />

<script>define.amd = false;</script>
<script src="../../node_modules/codemirror/lib/codemirror.js"></script>
<script src="../../node_modules/codemirror/addon/search/searchcursor.js"></script>
<script src="../../node_modules/codemirror/keymap/sublime.js"></script>
<script src="../../node_modules/codemirror/addon/edit/matchbrackets.js"></script>
<script src="../../node_modules/codemirror/addon/edit/closebrackets.js"></script>
<script src="../../node_modules/codemirror/mode/sql/sql.js"></script>
<script>define.amd = {};</script>
<script>
define('codemirror', function () {
  return window.CodeMirror;
});
</script>

<style>
  .CodeMirror {
    height: 100% !important;
    width: 100% !important;
  }

  .CodeMirror-vscrollbar {
    bottom: 25px !important;
  }

  .CodeMirror-hscrollbar {
    right: 109px !important;
    left: 0 !important;
  }

  .CodeMirror-gutters {
    border-right: 0px;
  }


  .CodeMirror div.CodeMirror-cursor {
    border-left-width: 1px;
    border-left-style: solid;
    border-left-color: inherit;
  }

  .CodeMirror-matchingbracket {
    text-decoration: underline;
  }




  .CodeMirror {
    font-family: Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;
    font-size: 20px;
    height: 100%;
  }

  .CodeMirror__annotations-gutter {
    width: 1em;
  }





  .CodeMirror__error-gutter-marker::before {
    width: 1em;
    line-height: 1.2em;
    font-size: .8em;
    content: '\e802';
    color: #ff4848;
    font-family: 'fontello';
    font-style: normal;
    font-weight: normal;
    speak: none;
    display: inline-block;
    margin-right: .2em;
    text-align: center;
    font-variant: normal;
    text-transform: none;
  }

  .CodeMirror__error-gutter-marker:hover::after {
    content: attr(data-title);
    display: block;
    position: absolute;
    font-size: 14px;
    white-space: pre;
    border-radius: .3em;
    padding: .3em;
    left: 2em;
  }

  /*.light*/ .CodeMirror__error-gutter-marker:hover::after {
    background-color: #555;
    color: #ddd;
    box-shadow: 0 0 .5em #999;
  }

  .dark .CodeMirror__error-gutter-marker:hover::after {
    background-color: #151515;
    color: #c2c2c2;
    box-shadow: 0 0 .5em #111;
  }



  /*.light*/ .CodeMirror { color: #2e383c; background-color: #fcfcfc; }
  /*.light*/ div.CodeMirror-selected { background: #ddd; }
  /*.light*/ div.CodeMirror span.CodeMirror-matchingbracket { color: black; }
  /*.light*/ .CodeMirror-gutters { background-color: #f5f5f5; }
  /*.light*/ .CodeMirror-gutters--overlaying { box-shadow: 0 0 .5em #ccc; }
  /*.light*/ .CodeMirror-guttermarker { color: #1d75b3; }
  /*.light*/ .CodeMirror-guttermarker-subtle { color: #e0e2e5; }
  /*.light*/ .CodeMirror-linenumber { color: #aaa; }

  /*.light*/ .cm-comment   { color: #75787b; }
  /*.light*/ .cm-keyword   { color: #1d75b3; }
  /*.light*/ .cm-property  { color: #1d75b3; }
  /*.light*/ .cm-atom      { color: #75438a; }
  /*.light*/ .cm-number    { color: #75438a; }
  /*.light*/ .cm-node      { color: #9c3328; }
  /*.light*/ .cm-tag       { color: #9c3328; }
  /*.light*/ .cm-string    { color: #b35e14; }
  /*.light*/ .cm-variable  { color: #047d65; }
  /*.light*/ .cm-qualifier { color: #047d65; }
  /*.light*/ .cm-builtin   { color: #1cadf1; }


  .dark .CodeMirror { color: #f8f8f2; background: #272822; }
  .dark div.CodeMirror-selected { background: #49483E; }
  .dark div.CodeMirror span.CodeMirror-matchingbracket { color: white; }
  .dark .CodeMirror-gutters { background: #2F3129; }
  .dark .CodeMirror-gutters--overlaying { box-shadow: 0 0 .5em #111; }
  .dark .CodeMirror-guttermarker { color: white; }
  .dark .CodeMirror-guttermarker-subtle { color: #8f908a; }
  .dark .CodeMirror-linenumber { color: #8f908a; }

  .dark .cm-comment { color: #75715e; }
  .dark .cm-atom { color: #ae81ff; }
  .dark .cm-number { color: #ae81ff; }
  .dark .cm-property,
  .dark .cm-attribute { color: #a6e22e; }
  .dark .cm-keyword { color: #f92672; }
  .dark .cm-string { color: #e6db74; }
  .dark .cm-variable { color: #a6e22e; }
  .dark .cm-variable-2 { color: #9effff; }
  .dark .cm-def { color: #fd971f; }
  .dark .cm-bracket { color: #f8f8f2; }
  .dark .cm-tag { color: #f92672; }
  .dark .cm-link { color: #ae81ff; }
  .dark .cm-error { color: #f8f8f0; background: #f92672; }
  .dark .cm-builtin { color: #8bdaff; }
</style>

<script>
require(['knockout', 'codemirror'], function (ko, CodeMirror) {
  ko.bindingHandlers['codemirror'] = {
    init: initCodemirror
  };

  function initCodemirror(element, valueAccessor, allBindings) {
      var codemirrorInst = CodeMirror.fromTextArea(element, {
          'lineNumbers': true,
          'matchBrackets': true,
          'showCursorWhenSelecting': true,
          'autoCloseBrackets': true,
          'autofocus': true,
          'mode': 'text/x-pgsql',
          'keyMap': 'sublime',
          'gutters': [
              'CodeMirror-linenumbers',
              'CodeMirror__annotations-gutter'
          ]
      });

      window.codemirrorInst = codemirrorInst;

      // add gutter shadow when scrolled horizontal
      codemirrorInst.on('scroll', function () {
          ko.utils.toggleDomNodeCssClass(
              codemirrorInst.display.gutters,
              'CodeMirror-gutters--overlaying',
              codemirrorInst.getScrollInfo().left > 1
          );
      });

      ko.computed(function () {
          var updatedDoc = allBindings.get('value');
          codemirrorInst.swapDoc(updatedDoc['codemirrorDoc']);
      });
  }
});
</script>

<script>
require(['knockout', 'codemirror'], function (ko, CodeMirror) {
  ko.extenders['codeEditorDoc'] = function (target) {
      var codemirrorDoc = new CodeMirror.Doc(target.peek() || '', 'text/x-pgsql');

      // use quoted keys to prevent properties conflict
      // after closure compiler rename
      ko.utils.extend(target, {
          'codemirrorDoc': codemirrorDoc,
          'errors': ko.observableArray(),
          'selectionRange': ko.observable()
      });

      function trackDocChange() {
          codemirrorDoc.on('change', function () {
              target(codemirrorDoc.getValue());
          });
      }

      if (target() == undefined /* not ready */) {
          var readySubscription = target.subscribe(function () {
              readySubscription.dispose();
              trackDocChange();
          }, null, 'ready');
      } else {
          trackDocChange();
      }

      codemirrorDoc.on('beforeSelectionChange', function (_, params) {
          var range = params['ranges'][0];
          target['selectionRange']({
              anchorLine: range['anchor']['line'],
              anchorCol: range['anchor']['ch'],
              headLine: range['head']['line'],
              headCol: range['head']['ch']
          });
      });

      target.subscribe(function (value) {
          if (codemirrorDoc.getValue() !== value) {
              codemirrorDoc.setValue(value);
          }
      });

      target['errors'].subscribe(function (changes) {
          changes.forEach(setError);
      }, null, 'arrayChange');

      function setError(change) {
          if ('moved' in change) {
              return;
          }

          var codemirrorInst = codemirrorDoc.getEditor();
          if (!codemirrorInst) {
              return;
          }

          switch (change.status) {
          case 'added':
              var marker = document.createElement('div');
              marker.className = 'CodeMirror__error-gutter-marker';
              marker.dataset.title = change.value.message;
              codemirrorInst.setGutterMarker(change.value['line'],
                                             'CodeMirror__annotations-gutter',
                                             marker);
              break;
          case 'deleted':
              codemirrorInst.setGutterMarker(change.value['line'],
                                             'CodeMirror__annotations-gutter',
                                             null);
              break;
          }
      }

      return target;
  };
})
</script>
