<link rel="import" href="../knockout.html" />
<link rel="import" href="../knockout-flatbind.html" />
<link rel="import" href="../bindings/cssmod.html" />
<link rel="import" href="pgbb-tree.html" />
<link rel="import" href="pgbb-myqueries.html" />

<style media="screen">
  .nav__tree,
  .nav__myqueries {
    margin: .5em;
  }
</style>

<script id="pgbb-nav-template" type="text/html">
  <div class="nav__myqueries"
       data-bind="component: {
         name: 'pgbb-myqueries',
         params: {
           selectItemCallback: selectMyQuery,
           addEvent: addMyQueryEvent,
           storage: myQueriesStorage
         }
       }"></div>

  <div class="nav__tree"
       data-bind="component: {
         name: 'pgbb-tree',
         params: {
           selectNodeCallback: selectTreeNode,
           nodes: databases
         }
       }"></div>
</script>

<script>
define('pgbb-nav-viewmodel', ['knockout'], function (ko) {
  /**
   * @constructor
   * @param {{selectedDoc}} params
   */
  function Nav(params) {
    /** @expose */
    this.myQueriesStorage = params['myQueriesStorage'];
    /** @expose */
    this.databases = params['databases'];
    /** @expose */
    this.selectTreeNode = this.selectTreeNode.bind(this);

    /** @expose */
    this.selectMyQuery = this.selectMyQuery.bind(this);

    this.selectedDoc = params['selectedDoc'];

    this.selectedItem = ko.observable();

    this.selectedItem.subscribe(
      this.onSelectingItem,
      this);

    this.selectedItem.subscribe(
      this.onUnselectingItem,
      this,
      'beforeChange');

    /** @expose */
    this.addMyQueryEvent = new ko.subscribable();

    this.createMyQueryWhenDocChange(this.selectedDoc());
  }

  Nav.prototype.selectTreeNode = function (selectingTreeNode) {
    this.selectedItem(selectingTreeNode);
    var doc = selectingTreeNode.getDoc();
    this.selectedDoc(doc);

    doc.subscribe(
      this.createMyQueryWhenDocChange.bind(this, doc),
      this,
      'ready');
  };

  Nav.prototype.selectMyQuery = function (selectingMyQuery) {
    this.selectedItem(selectingMyQuery);
    if (selectingMyQuery) {
      this.selectedDoc(selectingMyQuery.getDoc());
    } else {
      this.navigateToGreetingDoc();
    }
  };

  /** @private */
  Nav.prototype.createGreetingDoc = function () {
    return ko.observable('hello').extend({ codeEditorDoc: true });
  };

  /** @private */
  Nav.prototype.navigateToGreetingDoc = function () {
    var greetingDoc = this.createGreetingDoc();
    this.createMyQueryWhenDocChange(greetingDoc);
    this.selectedDoc(greetingDoc);
  };

  /** @private */
  Nav.prototype.onUnselectingItem = function (unselectingItem) {
    if (unselectingItem) {
      unselectingItem.isSelected(false);
    }
  };

  /** @private */
  Nav.prototype.onSelectingItem = function (selectingItem) {
    if (selectingItem) {
      selectingItem.isSelected(true);
    }
  };

  /** @private */
  Nav.prototype.createMyQueryWhenDocChange = function (doc) {
    this.docSubscription = doc.subscribe(function () {
      this.docSubscription.dispose();
      this.addMyQueryEvent.notifySubscribers(doc);
    }, this);
  };

  return Nav;
});
</script>

<script>
require(['knockout', 'pgbb-nav-viewmodel'], function (ko, viewModel) {
  ko.components.register('pgbb-nav', {
    synchronous: true,
    template: { element: 'pgbb-nav-template' },
    viewModel: viewModel
  });
});
</script>
