<link rel="import" href="../knockout.html" />
<link rel="import" href="../knockout-flatbind.html" />
<link rel="import" href="../bindings/cssmod.html" />
<link rel="import" href="../extenders/persist.html" />
<link rel="import" href="pgbb-splitpanel.html" />
<link rel="import" href="pgbb-nav.html" />
<link rel="import" href="pgbb-codeform.html" />
<link rel="import" href="pgbb-result.html" />
<link rel="import" href="pgbb-map.html" />
<link rel="import" href="../fontello.html" />

<style>
  .main {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    font-size: 16px;
    font-family: 'DejaVu Sans', 'Verdana', sans-serif;
  }

  /* .light */.main {
    color: #555;
    background-color: #eee;
  }

  .dark.main {
    color: #ddd;
    background-color: #333;
  }

  .main__leftbar {
    position: absolute;
    bottom: 0;
    top: 0;
    left: 0;
    padding: .5em .1em;
  }

  /* .light */ .main__leftbar {
    background-color: #eee;
    box-shadow: 0 0 .5em #ccc;
  }

  .dark .main__leftbar {
    background-color: #333;
    box-shadow: 0 0 .5em #151515;
  }

  .main__leftbar {
    z-index: 2;
  }

  .main__theme-toggler {
    outline: none;
    margin: 0;
    padding: 0;
    border: none;
    color: inherit;
    background: none;
    font-family: inherit;
    font-size: inherit;
    line-height: 1em;
    cursor: pointer;
    white-space: nowrap;
  }

  .main__theme-toggler::-webkit-focus-inner {
    border: 0;
    padding: 0;
  }

  .main__theme-toggler::-moz-focus-inner {
    border: 0;
    padding: 0;
  }

  .main__theme-toggler::before {
    font-family: 'fontello';
    font-style: normal;
    font-weight: normal;
    speak: none;
    display: inline-block;
    text-decoration: inherit;
    width: 1em;
    text-align: center;
    font-variant: normal;
    text-transform: none;
    line-height: 1em;
    font-size: 115%;

    content: '\e800';
  }

  .main__splitpanel-h {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 1.3125em;
  }

  .main__splitpanel-v,
  .main__codeform,
  .main__output,
  .main__nav {
    display: block;
    width: 100%;
    height: 100%;
  }

  .main__nav {
    overflow-x: hidden;
    overflow-y: auto;
    transform: translateZ(0);
  }

  /* iframe */.main__output {
    border: none;
  }

  .main__output {
    overflow: auto;
    transform: translateZ(0);
  }

  /* .light */ .main__nav,
  /* .light */ .main__codeform,
  /* .light */ .main__output {
    background-color: #fcfcfc;
  }

  .dark .main__nav,
  .dark .main__codeform,
  .dark .main__output {
    background-color: #272822;
  }


  *::-webkit-scrollbar {
    width: 12px;
    height: 12px;
    padding: 2px;
  }

  /*.light*/ *::-webkit-scrollbar,
  /*.light*/ *::-webkit-scrollbar-corner {
    background-color: #ddd;
  }

  .dark *::-webkit-scrollbar,
  .dark *::-webkit-scrollbar-corner {
    background-color: #222;
  }

  *::-webkit-scrollbar-button:start:decrement,
  *::-webkit-scrollbar-button:end:increment {
    display: block;
    height: 0;
    width: 0;
    background-color: transparent;
  }

  *::-webkit-scrollbar-thumb {
    border-radius: 6px;
    border: 2px solid;
  }

  /*.light*/ *::-webkit-scrollbar-thumb {
    background-color: #999;
    color: #ddd;
  }

  .dark *::-webkit-scrollbar-thumb {
    background-color: rgba(255,255,255,.2);
    color: #222;
  }

  .dark * {
    scrollbar-base-color: #333;
    scrollbar-3dlight-color: #222;
    scrollbar-highlight-color: #222;
    scrollbar-track-color: #222;
    scrollbar-arrow-color: #888;
    scrollbar-shadow-color: #222;
    scrollbar-dark-shadow-color: #222;
  }
</style>

<script id="pgbb-app-template" type="text/html">
  <div class="main"
       data-bind-css.dark="isDark">

    <div class="main__leftbar">
      <button class="main__theme-toggler"
              data-bind-click="toggleTheme">
      </button>
    </div>


    <div class="main__splitpanel-h"
         data-bind-component="'pgbb-splitpanel-h'">

      <div class="main__nav"
           slot="left"
           data-bind-component.name="'pgbb-nav'"
           data-bind-component.params.selected_doc="selectedDoc"
           data-bind-component.params.databases="databases"
           data-bind-component.params.my_queries_storage="myQueriesStorage">
      </div>

      <div class="main__splitpanel-v"
           slot="right"
           data-bind-component="'pgbb-splitpanel-v'">

        <form class="main__codeform"
              target="output-iframe"
              method="POST"
              action="exec"
              slot="top"
              data-bind-component.name="'pgbb-codeform'"
              data-bind-component.params.doc="selectedDoc"
              data-bind-submit="onCodeFormSubmit">
        </form>


        <div
          class="main__output"
          slot="bottom"
          data-bind-component="resultComponent">
        </div>

      </div>


    </div>
  </div>

  <button id="share-action"
          accesskey="s"
          style="display:none"
          ></button>

  <iframe hidden="hidden"
          name="output-iframe"
          data-bind="outputFrame: {
            doc: selectedDoc,
            isDark: isDark
          }"></iframe>
</script>

<script>
'use strict';

define('pgbb-app', function (require, exports) {
  var ko = require('knockout');

  class AppViewModel {
    constructor(params) {

      this.isDark = ko.observable().extend({
        persist: 'pgblackboard_isdark'
      });

      this.databases = (params.initialData || this.initialData).databases;

      var initialDoc = ko.observable(this.initialCode).extend({
        codeEditorDoc: true
      });

      this.selectedDoc = ko.observable(initialDoc);
      this.execResults = ko.observableArray();
      this.isMap = ko.observable(true);
      this.resultComponent = ko.pureComputed(_ => ({
        name: this.isMap() ? 'pgbb-map' : 'pgbb-result',
        params: {
          data: this.execResults,
          isDark: this.isDark
        }
      }));

      var execResults = this.execResults;
      var currentRowset;
      window.pushmsg = function (message) {
        var messageTag = message[0];
        var messagePayload = message[1];
        switch (messageTag) {
          case 'rowset':
            execResults.push({
              type: 'rowset',
              fields: messagePayload,
              rows: currentRowset = ko.observableArray().extend({
                rateLimit: {
                  timeout: 100,
                  method: 'notifyAtFixedRate'
                }
              })
            });
            break;

          case 'r':
            currentRowset.push(messagePayload);
            break;

          case 'non_query':
            execResults.push({
              type: 'nonquery',
              commandTag: messagePayload
            });
            break;

          case 'error':
            execResults.push({
              type: 'error',
              text: messagePayload
            });
            break;

          case 'notice':
            execResults.push({
              type: 'notice',
              text: messagePayload
            });
            break;

          case 'query_plan':
            execResults.push({
              type: 'queryplan',
              queryplan: messagePayload
            });
            break;

          default:
            console.error('Unknown message tag ' + messageTag, messagePayload);
            break;
        }
      };
    }

    toggleTheme() {
      this.isDark(!this.isDark());
    }

    onCodeFormSubmit() {
      this.execResults([]);

      if (this.selectedDoc().errors) {
        this.selectedDoc().errors.removeAll();
      }

      return true;
    }
  }

  ko.utils.extend(AppViewModel.prototype, {
    myQueriesStorage: window.localStorage,
    initialCode: window.location.hash || 'select \'awesome\'',
    initialData: {
      databases: []
    }
  });

  ko.components.register('pgbb-app', {
    synchronous: true,
    template: { element: 'pgbb-app-template' },
    viewModel: {
      createViewModel: function () {
        var initialDataElem = document.getElementById('pgbb-initial-data');
        var initialDataJson = initialDataElem && initialDataElem.textContent.trim();
        var initialData = initialDataJson && JSON.parse(initialDataJson);
        return new AppViewModel({ initialData: initialData });
      }
    }
  });

  exports.viewModel = AppViewModel;
});
</script>

<!-- <script>
require(['knockout', 'pgbb-app-viewmodel'], function (ko, viewModel) {



  var outEl = null;
  var tableEl;
  var tBodyEl;
  window.pushmsg = function (message) {
    outEl = outEl || document.querySelector('.main__output');

    switch (message[0]) {
      case "rowset":
        tBodyEl = document.createElement('tbody');
        tableEl = document.createElement('table');
        tableEl.className = 'rowset';
        tableEl.appendChild(tBodyEl);
        outEl.appendChild(tableEl);
        break;

      case "r":
        var rowHtml = '<tr>' + message[1].map(it => `<td>${it}</td>`).join('') + '</tr>';
        tBodyEl.insertAdjacentHTML('beforeend', rowHtml);
        break;

      default:

    }
  };

});
</script> -->
