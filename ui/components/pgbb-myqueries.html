<link rel="import" href="../knockout.html" />
<link rel="import" href="../knockout-flatbind.html" />
<link rel="import" href="../bindings/cssmod.html" />
<link rel="import" href="../fontello.html" />

<style>
  /*ul*/.myqueries-list {
    padding: 0;
    margin: 0;
    padding-left: 1em;
    list-style-type: none;
    white-space: nowrap;
    line-height: 1.4375;
  }

  /*.light*/.myquery:hover,
  /*.light*/.myquery--active {
    background-color: rgba(0,0,0,.1);
  }

  /*.light*/.myquery--active {
    color: black;
  }

  .dark .myquery:hover,
  .dark .myquery--active {
    background-color: rgba(255,255,255,.1);
  }

  .dark .myquery--active {
    color: white;
  }

  .myquery--active .myquery__name {
    width: calc(100% - 4em);
  }

  .myquery__name {
    display: inline-block;
    vertical-align: bottom;
    width: 100%;
    text-decoration: none;
    cursor: pointer;
    text-overflow: ellipsis;
    overflow: hidden;
    padding-left: .2em;
  }

  .myquery__icon::before {
    font-family: 'fontello';
    font-style: normal;
    font-weight: normal;
    speak: none;
    display: inline-block;
    text-decoration: inherit;
    width: 1em;
    text-align: center;
    font-variant: normal;
    text-transform: none;
    line-height: 1em;
    content: '\e80b';
  }

  .myquery__remove {
    display: inline-block;
    outline: none;
    margin: 0;
    padding: 0;
    border: none;
    color: inherit;
    background: none;
    font-family: inherit;
    cursor: pointer;
    white-space: nowrap;

    line-height: inherit;
    font-size: inherit;
    text-decoration-style: dotted;
    text-decoration: underline;
  }

  .myquery__remove::-webkit-focus-inner {
    border: 0;
    padding: 0;
  }

  .myquery__remove::-moz-focus-inner {
    border: 0;
    padding: 0;
  }
</style>

<script id="pgbb-myqueries-template" type="text/html">
  <ul class="myqueries-list" data-bind="foreach: items">
    <li>
      <div class="myquery"
           data-bind="css: { 'myquery--active': isSelected }">

        <a class="myquery__name" data-bind="click: $component.selectItem">
          <i class="myquery__icon"></i>
          <span data-bind="text: name"></span>
        </a>

        <button class="myquery__remove"
                data-bind="click: $component.removeItem, visible: isSelected"
                ><small>remove</small></button>

      </div>
    </li>
  </ul>
</script>

<script>
define('pgbb-myqueries-viewmodel', ['knockout'], function (ko) {
  /**
   * @constructor
   * @param {{selectItemCallback, addEvent}} params
   */
  function MyQueries(params) {
      this.storage = params['storage'];

      /** @expose */
      this.selectItem = params['selectItemCallback'];

      /** @expose */
      this.items = ko.observableArray(this.load());

      /** @expose */
      this.removeItem = this.removeItem.bind(this);

      this.addEventSubscription = params['addEvent'].subscribe(this.newItem, this);
  }

  /** @private */
  MyQueries.prototype.load = function () {
      var itemsCount = this.storage.length;
      var items = [];
      for (var i = 0; i < itemsCount; i++) {
          var key = this.storage.key(i);
          if (key.lastIndexOf(this.storageKeyPrefix, 0) === 0) {
              items.push(this.restoreItem(key));
          }
      }
      return items;
  };

  MyQueries.prototype.storageKeyPrefix = 'pgblackboard_query_';

  /** @private */
  MyQueries.prototype.newItem = function (doc) {
      var newStorageKey = this.storageKeyPrefix + new Date().getTime();
      this.storage.setItem(newStorageKey, doc());
      var item = this.createItem(doc, newStorageKey);
      this.items.push(item);
      this.selectItem(item);
      return item;
  };

  /** @private */
  MyQueries.prototype.restoreItem = function (storageKey) {
      var queryText = this.storage.getItem(storageKey);
      var doc = ko.observable(queryText).extend({ codeEditorDoc: true });
      return this.createItem(doc, storageKey);
  };

  /** @private */
  MyQueries.prototype.createItem = function (doc, storageKey) {
      return {
          /** @expose */
          name: ko.pureComputed(this.getQueryName.bind(this, doc))
                      .extend({ 'rateLimit': 500 }),

          /** @expose */
          isSelected: ko.observable(false),

          getDoc: function () { return doc; },
          storageKey: storageKey,
          docSubscription: doc.subscribe(
              this.storage.setItem.bind(this.storage, storageKey)
          )
      };
  };

  MyQueries.prototype.removeItem = function (removingItem) {
      removingItem.docSubscription.dispose();
      this.items.remove(removingItem);
      this.storage.removeItem(removingItem.storageKey);

      if (removingItem.isSelected()) {
          this.selectItem(null);
      }
  };

  /** @private */
  MyQueries.prototype.getQueryName = function (doc) {
      var queryText = ko.unwrap(doc).trim();
      var m = /\\connect\s+\w+\s*([\s\S]+)/.exec(queryText);
      if (m) {
          queryText = m[1];
      }
      m = /^create\s+(or\s+replace\s+)?([\s\S]+)/i.exec(queryText);
      if (m) {
          queryText = m[2];
      }

      return queryText.substr(0, 100) || '(empty)';
  };

  /** @expose */
  MyQueries.prototype.dispose = function () {
      this.addEventSubscription.dispose();
  };

  return MyQueries;
});
</script>

<script>
require(['knockout', 'pgbb-myqueries-viewmodel'], function (ko, viewModel) {
  ko.components.register('pgbb-myqueries', {
    synchronous: true,
    template: { element: 'pgbb-myqueries-template' },
    viewModel: viewModel
  });
});
</script>
