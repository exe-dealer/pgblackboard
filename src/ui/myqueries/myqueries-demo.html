<!DOCTYPE html>
<html>
<head>
  <title></title>
  <link href="myqueries.less" rel="stylesheet/less" />
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/2.4.0/less.js"></script>

  <script src="http://knockoutjs.com/downloads/knockout-3.2.0.debug.js"></script>
  <script src="myqueries.js"></script>

  <script>
    var req = new XMLHttpRequest();
    req.open('GET', 'myqueries.template.html', false);
    req.send();
    document.write(req.responseText);
  </script>

  <style>
    html {
      font-family: 'DejaVu Sans', 'Verdana', sans;
      background-color: #eee;
      font-style: 16px;
    }

    #myqueries-container {
      display: inline-block;
      width: 300px;
      vertical-align: top;
    }

    #editor-container {
      display: inline-block;
      vertical-align: top;
    }
  </style>
</head>
<body>

  <x-myqueries params="storage: storage"
       id="myqueries-container"
       ></x-myqueries>

  <div id="editor-container">
    <!-- ko with: currentDoc -->
      <textarea data-bind="textInput: $rawData, hasFocus: $parent.isEditorFocused()"></textarea>
    <!-- /ko -->
    <br />
    <button data-bind="click: blank">blank</button>
  </div>

  <script>
    var storage = {
      get length() { return Object.keys(this._items).length; },
      key: function (i) { return Object.keys(this._items)[i]; },
      getItem: function (key) { return this._items[key]; },
      setItem: function (key, val) { return this._items[key] = val; },
      removeItem: function (key) { delete this._items[key]; },
      _items: {}
    };

    storage.setItem('pgblackboard_query_1', 'some query');
    storage.setItem('pgblackboard_query_2', 'some awesome');

    MyQueries.prototype._storage = storage;

    var currentQuery = ko.observable();
    var currentDoc = ko.observable();

    ko.applyBindings({
      isEditorFocused: ko.observable(false),
      currentDoc: currentDoc,
      selectedItem: ko.observable(),
      blank: function () {
        var newDoc = ko.observable('');
        this.currentDoc(newDoc);
        this.selectedMyQuery(null);
        this.isEditorFocused(true);

        // subscribe once
        var subscribtion = newDoc.subscribe(function () {
          subscribtion.dispose();
          var newQuery = this.repo.newQuery(newDoc);
          currentQuery(newQuery);
        }, this);
      }
    });
  </script>
</body>
</html>
