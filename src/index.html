<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>pgBlackboard</title>

  <link href="assets/style.css" rel="stylesheet" />
  <link href="assets/splitpanel/splitpanel.css" rel="stylesheet" />
  <link href="assets/fontello/css/fontello-embedded.css" rel="stylesheet" />

  <script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js"></script>

  <script id="tree-tmpl" type="text/html">
    <ul data-bind="foreach: nodes">
      <li class="treenode" data-bind="css: { 'current': isOpened }">

        <button data-bind="click: toggle, visible: !isLeaf, css: {
              'treenode-toggler-collapsed': !isExpanded(),
              'treenode-toggler-expanded': isExpanded,
              'spinner': childrenAreLoading }"></button>

        <header>
          <a class="treenode-icon"
             data-bind="click: $root.openTreeNode.bind($root),
                        attr: { title: comment, 'data-type': type }"
            ><!-- ko text: name --><!-- /ko -->
            <small data-bind="text: comment"></small>
          </a>
        </header>

        <!-- ko template: {
          name: 'tree-tmpl',
          if: isExpanded
        } --><!-- /ko -->

      </li>
    </ul>
  </script>

  <script id="queries-tmpl" type="text/html">
    <ul data-bind="foreach: items">
      <li data-bind="css: { current: isOpened }">
        <header>
          <a class="icon-code"
            data-bind="click: $root.openStoredQuery.bind($root),
                       text: name"></a>

          <button data-bind="click: $root.removeStoredQuery.bind($root)">remove</button>

        </header>
      </li>
    </ul>
  </script>

  <script id="databases" type="text/sql">
    select datname as name
        ,shobj_description(oid, 'pg_database') as comment
        ,datname as database
        ,'schemas_in_db' as childquery
        ,'database' as type
    from pg_database
    where not datistemplate
  </script>

  <script id="schemas_in_db" type="text/sql">
    select nspname as name
        ,oid
        ,obj_description(oid, 'pg_namespace') as comment
        ,current_database() as database
        ,'rels_and_funcs_in_schema' as childquery
        ,'schema' as type
    from pg_namespace
    where nspname not like 'pg\_temp\_%'
        and nspname not like 'pg\_toast\_temp\_%'
        and nspname != 'pg_toast'
    order by name
  </script>

  <script id="rels_and_funcs_in_schema" type="text/sql">
    (select relname as name
        ,obj_description(oid, 'pg_class') as comment
        ,oid
        ,current_database() as database
        ,case relkind when 'r' then 'table_def'
                      when 'v' then 'view_def'
                      when 'm' then 'matview_def'
                      when 'f' then 'table_def'
                      end as defquery
        ,'columns_in_rel' as childquery
        ,case relkind when 'r' then 'table'
                      when 'v' then 'view'
                      when 'f' then 'foreigntable'
                      when 'm' then 'matview'
                      end as type
    from pg_class
    where relnamespace = $1 and relkind in ('r', 'v', 'm', 'f')
    order by name
    ) union all (
    select format('%s(%s)'
            ,proname
            ,array_to_string(proargtypes::regtype[], ', ')
        ) as name
        ,obj_description(oid, 'pg_proc') as comment
        ,oid
        ,current_database() as database
        ,'func_def' as defquery
        ,null as childquery
        ,'func' as type
    from pg_proc
    where pronamespace = $1
    order by name)
  </script>

  <script id="columns_in_rel" type="text/sql">
    select format('%s : %s', attname, format_type(atttypid, null)) as name
        ,col_description(attrelid, attnum) as comment
        ,case when indisprimary then 'pk_column'
              when exists(select 1
                from pg_constraint
                where conrelid = attrelid and
                    attnum = any(conkey) and
                    contype = 'f') then 'fk_column'
              else 'column'
              end as type
        ,current_database() as database
    from pg_attribute
        left outer join pg_index on indrelid = attrelid and
                                    attnum = any(indkey) and
                                    indisprimary
    where attrelid = $1 and attnum > 0 and not attisdropped
    order by attnum
  </script>

  <script id="table_def" type="text/sql">
    select format(e'select %s \nfrom %s \nlimit 1000;'
        ,string_agg(quote_ident(attname), e',\n    ' order by attnum)
        ,$1::int::regclass) as def
    from pg_attribute
    where attrelid = $1 and attnum > 0 and not attisdropped
  </script>

  <script id="view_def" type="text/sql">
    select format(e'select %1$s \nfrom %2$s \nlimit 1000;\n\n'
               || e'/*\n CREATE VIEW %2$s AS\n%3$s\n*/'
        ,string_agg(quote_ident(attname), e',\n    ' order by attnum)
        ,$1::int::regclass
        ,pg_get_viewdef($1)) as def
    from pg_attribute
    where attrelid = $1 and attnum > 0 and not attisdropped
  </script>

  <script id="matview_def" type="text/sql">
    select format(e'select %1$s \nfrom %2$s \nlimit 1000;\n\n'
               || e'/*\n CREATE MATERIALIZED VIEW %2$s AS\n%3$s\n*/'
        ,string_agg(quote_ident(attname), e',\n    ' order by attnum)
        ,$1::int::regclass
        ,pg_get_viewdef($1)) as def
    from pg_attribute
    where attrelid = $1 and attnum > 0 and not attisdropped
  </script>

  <script id="func_def" type="text/sql">
    select pg_get_functiondef($1) as def
  </script>
</head>
<body class="splitpanel-h">

  <section id="leftpanel" class="scrollbox splitfix">
    <!-- ko template: { name: 'queries-tmpl', data: queries } --><!-- /ko -->
    <!-- ko template: { name: 'tree-tmpl', data: tree } --><!-- /ko -->
  </section>

  <div class="splitter"></div>

  <section class="splitstretch splitpanel-v">
    <form id="queryform" method="POST" action="" target="result"
      class="splitstretch" enctype="multipart/form-data">

      <code id="editor"></code>

      <input type="hidden" name="database" />
      <input type="hidden" name="query" />

      <div id="execbar">
        <button type="submit" title="Alt+M" accesskey="m"
          name="format" value="map">map</button>

        <button type="submit" title="Alt+E" accesskey="e"
          name="format" value="html">execute</button>
      </div>

      <div class="spinner-shield"
        data-bind="visible: queryTextIsLoading()">
        <div class="spinner"></div>
      </div>

    </form>
    <div class="splitter"></div>
    <iframe id="result" name="result" class="scrollbox splitfix"></iframe>
  </section>

  <script>window.pgbb = {};</script>
  <script src="assets/splitpanel/splitpanel.js"></script>
  <script src="assets/tree.js"></script>
  <script src="assets/queries.js"></script>
  <script src="assets/editor.js"></script>
  <script src="assets/script.js"></script>
</body>
</html>
